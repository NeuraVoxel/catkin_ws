<!DOCTYPE html>
<html>

<head>
    <title>ROS Time Sync Client</title>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
</head>

<body>
    <h1>Time Synchronization Client</h1>

    <input type="text" id="timestampInput" placeholder="YYYY-MM-DD HH:MM:SS">
    <button onclick="callService()">Sync Time</button>

    <div id="result"></div>

    <script>
        // 连接 ROS
        const ros = new ROSLIB.Ros({
            url: 'ws://localhost:9090'  // rosbridge WebSocket 地址
        });

        // 错误处理
        ros.on('error', (error) => {
            console.error('Connection error:', error);
            document.getElementById('result').innerHTML = 'Connection Failed';
        });

        // 创建 Service 客户端
        const timeSyncService = new ROSLIB.Service({
            ros: ros,
            name: '/time_sync',
            serviceType: 'time_sync_cpp/TimeSync'  // 与服务类型一致
        });

        // 服务调用函数
        function callService() {
            const timestamp = document.getElementById('timestampInput').value || getCurrentTimestamp();  // 若为空则使用当前时间

            console.log('Timestamp:', timestamp);

            // 构造请求
            const request = new ROSLIB.ServiceRequest({
                timestamp: timestamp
            });

            // 调用服务
            timeSyncService.callService(request, (response) => {

                document.getElementById('result').innerHTML =
                    `Result: ${response.result}`;
            }, (error) => {

                document.getElementById('result').innerHTML =
                    `Error: ${error}`;
            });
        }

        function getCurrentTimestamp() {
            // 获取基准时间（毫秒级）
            const now = new Date();
            const baseTime = now.getTime(); // 单位：毫秒

            // 获取高精度相对时间（微秒级）
            const perf = performance.now(); // 单位：毫秒，但小数部分为微秒
            const microSeconds = (perf % 1) * 1000; // 提取微秒部分（0~999微秒）

            // 构造本地时间字符串（格式：YYYY-MM-DD HH:mm:ss）
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            // 合成纳秒部分（伪纳秒：毫秒*1e6 + 微秒*1e3）
            const nanoSeconds = String(Math.floor(microSeconds * 1000)).padStart(9, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${nanoSeconds}`;
        }
    </script>
</body>

</html>